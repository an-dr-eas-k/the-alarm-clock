<!DOCTYPE html>
<html>

<head>
	<title>Alarm Clock</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<style>
		label {
			width: 200px;
			margin-top: 1.5rem;
		}
	</style>

	<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

	<script>
		function formToJSON(formData) {
			var jsonData = {};

			for (var pair of formData.entries()) {
				var key = pair[0];
				var value = pair[1];

				if (jsonData.hasOwnProperty(key)) {
					if (Array.isArray(jsonData[key])) {
						jsonData[key].push(value);
					} else {
						jsonData[key] = [jsonData[key], value];
					}
				} else {
					jsonData[key] = value;
				}
			}
			return jsonData;
		}

		function onClickDelete(type, event) {
			sendToBackend('/api/config/' + type + '/' + event.target.value, 'DELETE', null);
			location.reload();
		}

		function onClickToggleAddForm(id) {
			const container = document.getElementById(id);
			displayStyle = container.style.display
			if (displayStyle == 'none') {
				container.style.display = 'block';
			} else {
				container.style.display = 'none';
			}
		}

		function onSubmitNew(event) {
			event.preventDefault();
			console.log(event)

			var formData = new FormData(event.target);
			var jsonData = formToJSON(formData);
			sendToBackend(event.target.action, 'POST', JSON.stringify(jsonData));
			location.reload();
		}

		function sendToBackend(url, method, content) {
			var xhr = new XMLHttpRequest();
			xhr.open(method, url);
			xhr.setRequestHeader('Content-Type', 'application/json');
			xhr.onload = function () {
				if (xhr.status !== 200) {
					console.error('Request failed. Status:', xhr.status);
				}
			};
			xhr.send(content);
		}

		function updateVolume(event) {
			console.log(event.target.value)
			document.getElementById('volumeValue').textContent = event.target.value;
		}
	</script>

</head>

<body data-bs-theme="dark">
	<div class="container">
		<div id="alarm-container" class="row">
			<h3>Existing Alarms</h3>
			<table class="table table-striped">
				<tr>
					<th>Name</th>
					<th>Time</th>
					<th>Weekdays</th>
					<th>Stream</th>
					<th>Volume</th>
					<th>is active</th>
					<th style="width: 1%"></th>
				</tr>
				{% for alarm_definition in config.alarm_definitions %}
				<tr>
					<td>{{ escape(alarm_definition.alarm_name) }}</td>
					<td>{{ escape(f"{alarm_definition.to_time_string()}") }}</td>
					<td>{{ escape(alarm_definition.to_weekdays_string()) }}</td>
					<td>{{ escape(alarm_definition.audio_effect.stream_definition.stream_name ) }}</td>
					<td>{{ alarm_definition.audio_effect.volume }}</td>
					<td>{{ escape(str(alarm_definition.is_active)) }}</td>
					<td>
						<button type="submit" class="btn btn-primary" value="{{ alarm_definition.id }}"
							onclick="onClickDelete('alarm', event)">Delete</button>
					</td>
				</tr>
				{% end %}
				<tr>
					<td colspan="4">
						<div id="add-alarm-container" style="margin: 20px; display:none;">
							<h3>Add Alarm</h3>
							<form id="alarm-form" action="/api/config/alarm" method="post" onsubmit="onSubmitNew(event)">
								<div class="form-group">
									<label for="nametextfield">Name:</label>
									<div class="input-group alarmName" id="nametextfield">
										<input type="text" class="form-control" name="alarmName" />
									</div>
								</div>
								<div class="form-group">
									<label for="timepicker">Time:</label>
									<div class="input-group date" id="timepicker">
										<input type="time" class="form-control" name="time" />
									</div>
								</div>
								<div class="form-group">
									<label for="daypicker">Weekdays:</label>
									<select multiple class="form-control" name="weekdays" id="daypicker" size="7">
										<option value="monday">Monday</option>
										<option value="tuesday">Tuesday</option>
										<option value="wednesday">Wednesday</option>
										<option value="thursday">Thursday</option>
										<option value="friday">Friday</option>
										<option value="saturday">Saturday</option>
										<option value="sunday">Sunday</option>
									</select>
								</div>
								<div class="form-group">
									<label for="stream-picker">Stream:</label>
									<select class="form-control" name="streamId" id="stream-picker" size="">
										{% for stream in config.audio_streams %}
										<option value="{{ stream.id }}">{{ escape(stream.stream_name) }}</option>
										{% end %}
									</select>
								</div>
								<div class="form-group">
									<label for="volume-picker">Volume:</label>
									<input id="volume-picker" name="volume" type="range" min="0" value="0.9" max="1" step="0.01"
										oninput="updateVolume(event)">
									<span id="volumeValue"></span>
								</div>
								<div class="form-group">
									<label for="activepicker">Active:</label>
									<input type="checkbox" checked name="isActive" id="activepicker" />
								</div>
								<button type="submit" class="btn btn-primary">Add Alarm</button>
							</form>
						</div>
					</td>
					<td>
						<button type="submit" class="btn btn-primary" onclick="onClickToggleAddForm('add-alarm-container')"
							style="width: 100%;">+</button>
					</td>
				</tr>
			</table>
		</div>
		<div id="audio-stream-container" class="row">
			<h3>Audio Streams</h3>
			<table class="table table-striped">
				<tr>
					<th>Name</th>
					<th>Url</th>
					<th style="width: 1%"></th>
				</tr>
				{% for audio_stream in config.audio_streams %}
				<tr>
					<td>{{ escape(audio_stream.stream_name) }}</td>
					<td>{{ escape(audio_stream.stream_url) }}</td>
					<td>
						<button type="submit" class="btn btn-primary" value="{{ audio_stream.id }}"
							onclick="onClickDelete('stream', event)">Delete</button>
					</td>
				</tr>
				{% end %}
				<tr>
					<td colspan="2">
						<div id="add-stream-container" style="margin: 20px; display:none;">
							<h3>Add Audio Stream</h3>
							<form id="stream-form" action="/api/config/stream" method="post" onsubmit="onSubmitNew(event)">
								<div class="form-group">
									<label for="name">Name:</label>
									<div class="input-group streamName" id="name">
										<input type="text" class="form-control" name="streamName" />
									</div>
								</div>
								<div class="form-group">
									<label for="url">Url:</label>
									<div class="input-group" id="url">
										<input type="text" class="form-control" name="streamUrl" />
									</div>
								</div>
								<button type="submit" class="btn btn-primary">Add Stream</button>
							</form>
						</div>
					</td>
					<td>
						<button type="submit" class="btn btn-primary" onclick="onClickToggleAddForm('add-stream-container')"
							style="width: 100%;">+</button>
					</td>
				</tr>
			</table>
		</div>
	</div>
</body>

</html>